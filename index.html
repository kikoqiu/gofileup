<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>File Transfer</title>
    <style>
        :root {
            --bg-color: #121212; --text-color: #e0e0e0; --primary-color: #007aff;
            --success-color: #34c759; --error-color: #ff3b30; --input-bg: #1c1c1e;
            --border-color: #2c2c2d; --bubble-bg: #2c2c2e; --bubble-self-bg: #007aff;
            --withdraw-color: #ff9500; --download-color: #5856d6; --hover-bg: rgba(255, 255, 255, 0.1);
        }
        html, body { margin: 0; padding: 0; height: 100%; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; background-color: var(--bg-color); color: var(--text-color); overflow: hidden; }
        #app-container { display: flex; flex-direction: column; height: 100%; }
        #header { padding: 10px 15px; background-color: var(--input-bg); border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; position: relative; flex-shrink: 0; }
        #header h1 { font-size: 1.1em; margin: 0; font-weight: 600; }
        #header-buttons { display: flex; align-items: center; gap: 8px; }
        .header-btn { background: none; border: none; padding: 5px; cursor: pointer; }
        .header-btn svg { width: 24px; height: 24px; fill: var(--text-color); transition: fill 0.2s; }
        .header-btn:hover svg { fill: var(--primary-color); }
        #dropdown-menu { display: none; position: absolute; top: 100%; right: 15px; background-color: #2c2c2e; border: 1px solid var(--border-color); border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); z-index: 10; overflow: hidden; }
        #dropdown-menu a { display: block; padding: 10px 20px; color: var(--text-color); text-decoration: none; font-size: 0.9em; }
        #dropdown-menu a:hover { background-color: #3a3a3c; }
        #dropdown-menu a.danger { color: var(--error-color); }
        #message-list { flex-grow: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column-reverse; }
        .message-wrapper { display: flex; flex-direction: column; align-items: flex-start; margin-bottom: 12px; max-width: 85%; }
        .message-wrapper.self { align-items: flex-end; align-self: flex-end; }
        .message-item { max-width: 100%; padding: 10px 15px; border-radius: 18px; background-color: var(--bubble-bg); word-wrap: break-word; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
        .message-wrapper.self .message-item { background-color: var(--bubble-self-bg); color: white; }
        .message-content .filename { font-weight: bold; margin-bottom: 2px; }
        .message-content .text-content { white-space: pre-wrap; }
        .filesize { font-size: 0.8em; color: rgba(255,255,255,0.6); margin-top: 4px; }
        .message-wrapper.self .filesize { color: rgba(255,255,255,0.8); }
        .progress-bar-container { height: 6px; background-color: rgba(0,0,0,0.2); border-radius: 3px; margin-top: 8px; overflow: hidden; }
        .progress-bar { height: 100%; width: 0; background-color: white; opacity: 0.7; border-radius: 3px; transition: width 0.2s ease-out; }
        .status-text { font-size: 0.8em; margin-top: 4px; color: rgba(255,255,255,0.7); }
        .message-footer { display: flex; justify-content: flex-end; align-items: center; font-size: 0.75em; margin-top: 6px; }
        .message-wrapper .message-footer { color: rgba(255,255,255,0.7); }
        .message-wrapper.self .message-footer { color: rgba(255,255,255,0.8); }
        .footer-timestamp { margin-right: auto; }
        .footer-btn { background: none; border: none; cursor: pointer; padding: 4px; margin-left: 8px; font-size: 0.9em; border-radius: 4px; }
        .footer-btn:hover { background-color: var(--hover-bg); }
        .download-btn { color: var(--download-color); }
        .withdraw-btn { color: var(--withdraw-color); }
        .message-wrapper.self .download-btn { color: rgba(255,255,255,0.8); }
        .message-wrapper.self .withdraw-btn { color: rgba(255,255,255,0.8); }
        #controls { display: flex; align-items: flex-end; padding: 10px 15px; background-color: var(--input-bg); border-top: 1px solid var(--border-color); flex-shrink: 0; gap: 10px; }
        #attachment-btn { background: none; border: none; padding: 8px; cursor: pointer; }
        #attachment-btn svg { width: 28px; height: 28px; fill: var(--primary-color); }
        #input-wrapper { flex-grow: 1; background-color: var(--bg-color); border: 1px solid var(--border-color); border-radius: 18px; display: flex; align-items: flex-end; }
        #text-input { flex-grow: 1; padding: 10px 15px; border: none; background: transparent; color: var(--text-color); outline: none; resize: none; font-size: 16px; max-height: 120px; overflow-y: auto; }
        #send-btn { background: none; border: none; padding: 8px 15px 8px 8px; cursor: pointer; align-self: center; }
        #send-btn svg { width: 28px; height: 28px; fill: var(--primary-color); transition: transform 0.2s ease; }
        #send-btn.active svg { transform: scale(1.1); }
        #attachment-popover { display: none; position: fixed; bottom: 70px; left: 15px; background-color: #2c2c2e; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); z-index: 10; padding: 8px; }
        .popover-item { display: flex; align-items: center; padding: 10px 15px; cursor: pointer; border-radius: 8px; }
        .popover-item:hover { background-color: #3a3a3c; }
        .popover-item svg { width: 24px; height: 24px; fill: var(--text-color); margin-right: 15px; }
        input[type="file"] { display: none; }
    </style>
</head>
<body>
<div id="app-container">
    <div id="header">
        <h1 data-i18n="headerTitle">File Transfer</h1>
        <div id="header-buttons">
            <button id="refresh-btn" class="header-btn" data-i18n-title="refreshBtnTitle">
                <svg viewBox="0 0 24 24"><path d="M17.65,6.35C16.2,4.9 14.21,4 12,4A8,8 0 0,0 4,12A8,8 0 0,0 12,20C15.73,20 18.84,17.45 19.73,14H17.65C16.83,16.33 14.61,18 12,18A6,6 0 0,1 6,12A6,6 0 0,1 12,6C13.66,6 15.14,6.69 16.22,7.78L13,11H20V4L17.65,6.35Z" /></svg>
            </button>
            <button id="menu-btn" class="header-btn" data-i18n-title="menuBtnTitle">
                <svg viewBox="0 0 24 24"><path d="M3,6H21V8H3V6M3,11H21V13H3V11M3,16H21V18H3V16Z" /></svg>
            </button>
        </div>
        <div id="dropdown-menu">
            <a href="#" id="clear-records-btn" class="danger" data-i18n="clearRecordsBtn">Clear Records</a>
        </div>
    </div>
    <div id="message-list"></div>
    <div id="controls">
        <button id="attachment-btn" data-i18n-title="attachmentBtnTitle">
            <svg viewBox="0 0 24 24"><path d="M12,18A6,6 0 0,1 6,12C6,8.69 8.69,6 12,6A6,6 0 0,1 18,12C18,15.31 15.31,18 12,18M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2M12,4A8,8 0 0,1 20,12A8,8 0 0,1 12,20A8,8 0 0,1 4,12A8,8 0 0,1 12,4M12,10.5A1.5,1.5 0 0,0 10.5,12A1.5,1.5 0 0,0 12,13.5A1.5,1.5 0 0,0 13.5,12A1.5,1.5 0 0,0 12,10.5Z" /></svg>
        </button>
        <div id="input-wrapper">
            <textarea id="text-input" rows="1" data-i18n-placeholder="textInputPlaceholder"></textarea>
            <button id="send-btn" data-i18n-title="sendBtnTitle">
                <svg viewBox="0 0 24 24"><path d="M2,21L23,12L2,3V10L17,12L2,14V21Z" /></svg>
            </button>
        </div>
    </div>
</div>
<div id="attachment-popover">
    <div class="popover-item" id="upload-image-btn">
        <svg viewBox="0 0 24 24"><path d="M21,19V5C21,3.89 20.1,3 19,3H5A2,2 0 0,0 3,5V19A2,2 0 0,0 5,21H19A2,2 0 0,0 21,19M8.5,13.5L11,16.5L14.5,12L19,18H5L8.5,13.5Z" /></svg>
        <span data-i18n="uploadImage">Image</span>
    </div>
    <div class="popover-item" id="upload-file-btn">
        <svg viewBox="0 0 24 24"><path d="M13,9H18.5L13,3.5V9M6,2H14L20,8V20A2,2 0 0,1 18,22H6C4.89,22 4,21.1 4,20V4C4,2.89 4.89,2 6,2M15,18H6V20H15V18M18,15H6V17H18V15Z" /></svg>
        <span data-i18n="uploadFile">File</span>
    </div>
</div>
<input type="file" id="image-picker" accept="image/*" multiple>
<input type="file" id="file-picker" multiple>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- i18n Setup ---
    const translations = {
        en: {
            headerTitle: "File Transfer", refreshBtnTitle: "Refresh Messages", menuBtnTitle: "Menu", clearRecordsBtn: "Clear Records", attachmentBtnTitle: "Attach", uploadImage: "Image", uploadFile: "File", textInputPlaceholder: "Type something...", sendBtnTitle: "Send", confirmClearRecords: "Are you sure you want to clear all local message records? This action cannot be undone.", withdraw: "Withdraw", withdrawing: "Withdrawing...", download: "Download", uploading: "Uploading...", withdrawFailed: "Withdraw failed!", confirmLocalDelete: "The file may not exist on the server.\n\nDelete this record locally anyway?", defaultTextFilename: "TextMessage", uploadFailed: "Upload Failed"
        },
        zh: {
            headerTitle: "文件传输", refreshBtnTitle: "刷新消息", menuBtnTitle: "菜单", clearRecordsBtn: "清空记录", attachmentBtnTitle: "附件", uploadImage: "图片", uploadFile: "文件", textInputPlaceholder: "输入文本...", sendBtnTitle: "发送", confirmClearRecords: "确定要清空所有本地消息记录吗？此操作不可恢复。", withdraw: "撤回", withdrawing: "撤回中...", download: "下载", uploading: "正在上传...", withdrawFailed: "撤回失败！", confirmLocalDelete: "服务器可能已不存在该文件。\n\n是否仅从本地删除此条记录？", defaultTextFilename: "文本消息", uploadFailed: "上传失败"
        }
    };
    const userLang = navigator.language.slice(0, 2);
    const lang = translations[userLang] ? userLang : 'en';
    const t = (key) => translations[lang][key] || key;
    function applyStaticTranslations() {
        document.title = t('headerTitle');
        document.querySelectorAll('[data-i18n]').forEach(el => el.innerText = t(el.dataset.i18n));
        document.querySelectorAll('[data-i18n-placeholder]').forEach(el => el.placeholder = t(el.dataset.i18nPlaceholder));
        document.querySelectorAll('[data-i18n-title]').forEach(el => el.title = t(el.dataset.i18nTitle));
    }

    // --- Element Selectors ---
    const messageList = document.getElementById('message-list');
    const attachmentBtn = document.getElementById('attachment-btn');
    const attachmentPopover = document.getElementById('attachment-popover');
    const imageBtn = document.getElementById('upload-image-btn');
    const fileBtn = document.getElementById('upload-file-btn');
    const sendBtn = document.getElementById('send-btn');
    const textInput = document.getElementById('text-input');
    const imagePicker = document.getElementById('image-picker');
    const filePicker = document.getElementById('file-picker');
    const menuBtn = document.getElementById('menu-btn');
    const dropdownMenu = document.getElementById('dropdown-menu');
    const clearRecordsBtn = document.getElementById('clear-records-btn');
    const refreshBtn = document.getElementById('refresh-btn');

    const STORAGE_KEY = 'mobile-upload-messages';
    
    // --- Storage Management ---
    const storage = {
        getMessages: () => {
            const now = Date.now();
            const thirtyDaysAgo = now - 30 * 24 * 60 * 60 * 1000;
            try {
                const messages = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
                const recentMessages = messages.filter(m => m.timestamp > thirtyDaysAgo);
                if (messages.length !== recentMessages.length) storage.saveMessages(recentMessages);
                return recentMessages;
            } catch (e) { return []; }
        },
        saveMessages: (messages) => localStorage.setItem(STORAGE_KEY, JSON.stringify(messages)),
        addMessage: (message) => { const msgs = storage.getMessages(); msgs.push(message); storage.saveMessages(msgs); },
        updateMessage: (id, updates) => {
            const msgs = storage.getMessages();
            const index = msgs.findIndex(m => m.id === id);
            if (index !== -1) { msgs[index] = { ...msgs[index], ...updates }; storage.saveMessages(msgs); }
        },
        removeMessage: (id) => { let msgs = storage.getMessages(); msgs = msgs.filter(m => m.id !== id); storage.saveMessages(msgs); },
        clearAll: () => localStorage.removeItem(STORAGE_KEY),
    };

    // --- Utils ---
    const formatTimestamp = (ts) => {
        const d = new Date(ts);
        return `${(d.getMonth() + 1).toString().padStart(2, '0')}-${d.getDate().toString().padStart(2, '0')} ${d.getHours().toString().padStart(2, '0')}:${d.getMinutes().toString().padStart(2, '0')}`;
    };
    const formatBytes = (bytes, decimals = 2) => {
        if (!+bytes) return '0 Bytes';
        const k = 1024; const dm = decimals < 0 ? 0 : decimals; const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return `${parseFloat((bytes / Math.pow(k, i)).toFixed(dm))} ${sizes[i]}`;
    };
    const escapeHTML = (str) => str.replace(/&/g, '&').replace(/</g, '<').replace(/>/g, '>').replace(/"/g, '"').replace(/'/g, '\'');
    const generateFilenameFromText = (text) => {
        const lines = text.split('\n'); let name = ''; const regex = /[<>:"/\\|?*\s]/g;
        for (const line of lines) { const sanitized = line.replace(regex, ''); if (sanitized.length > 0) { name = sanitized.substring(0, 20); break; } }
        return name || t('defaultTextFilename');
    };
    const scrollToBottom = () => { messageList.scrollTop = 0; };
    
    // --- UI Rendering ---
    const renderMessage = (msg) => {
        const isSelf = msg.direction !== 'in';
        const msgContent = msg.isText ? msg.content : (msg.fileName || msg.content);
        let contentHtml;
        if (msg.isText) {
            let textToDisplay = msg.content;
            if (textToDisplay.split('\n').length > 8 || textToDisplay.length > 100) { textToDisplay = textToDisplay.substring(0, 100) + '...'; }
            contentHtml = `<div class="text-content">${escapeHTML(textToDisplay).replace(/\n/g, '<br>')}</div>`;
        } else {
            const sizeHtml = msg.size ? `<div class="filesize">${formatBytes(msg.size)}</div>` : '';
            contentHtml = `<div class="filename">${escapeHTML(msgContent)}</div>${sizeHtml}`;
        }
        let footerHtml = '';
        if (msg.status === 'success') {
            const timeStr = formatTimestamp(msg.timestamp);
            const downloadBtn = `<button class="footer-btn download-btn" data-path="${msg.filePath}" title="${t('download')}">${t('download')}</button>`;
            const withdrawBtn = `<button class="footer-btn withdraw-btn" data-id="${msg.id}" data-path="${msg.filePath}" title="${t('withdraw')}">${t('withdraw')}</button>`;
            footerHtml = `<div class="message-footer"><span class="footer-timestamp">${timeStr}</span>${downloadBtn}${withdrawBtn}</div>`;
        }
        const progressHtml = msg.status === 'pending' ? `<div class="status-text">${t('uploading')} 0%</div><div class="progress-bar-container"><div class="progress-bar"></div></div>` : '';
        const errorHtml = msg.status === 'error' ? `<div class="message-footer"><span style="color:var(--error-color);">${t('uploadFailed')}</span></div>` : '';
        const messageHtml = `<div class="message-wrapper ${isSelf ? 'self' : ''}" id="${msg.id}"><div class="message-item ${msg.status || 'success'}"><div class="message-content">${contentHtml}</div>${progressHtml}${footerHtml}${errorHtml}</div></div>`;
        messageList.insertAdjacentHTML('afterbegin', messageHtml);
    };

    const reRenderAllMessages = () => {
        messageList.innerHTML = '';
        storage.getMessages().sort((a, b) => a.timestamp - b.timestamp).forEach(renderMessage);
        scrollToBottom();
    };

    // --- Core Logic ---
    const fetchAndMergeHistory = async () => {
        try {
            refreshBtn.firstElementChild.style.animation = 'spin 1s linear infinite';
            const response = await fetch('/history'); if (!response.ok) throw new Error('Failed to fetch history');
            const serverHistory = await response.json(); const localMessages = storage.getMessages();
            const serverFilePaths = new Set(serverHistory.map(m => m.filePath));
            let uiNeedsUpdate = false;

            // Sync Deletions: Use a 6-day window for safety against clock skew.
            const sixDaysAgo = Date.now() - 6 * 24 * 60 * 60 * 1000;
            const messagesToDelete = [];
            localMessages.forEach(localMsg => {
                if (localMsg.status === 'success' && localMsg.filePath && localMsg.timestamp > sixDaysAgo && !serverFilePaths.has(localMsg.filePath)) {
                    messagesToDelete.push(localMsg.id);
                }
            });
            if (messagesToDelete.length > 0) {
                messagesToDelete.forEach(id => storage.removeMessage(id));
                uiNeedsUpdate = true;
            }
            
            const updatedLocalMessages = storage.getMessages();
            const localFilePaths = new Set(updatedLocalMessages.map(m => m.filePath).filter(Boolean));
            serverHistory.forEach(serverMsg => {
                if (serverMsg.filePath && !localFilePaths.has(serverMsg.filePath)) {
                    storage.addMessage({
                        id: `msg-server-${serverMsg.timestamp}`, content: serverMsg.isText ? serverMsg.content : serverMsg.fileName,
                        fileName: serverMsg.fileName, size: serverMsg.size, isText: serverMsg.isText, status: 'success',
                        timestamp: serverMsg.timestamp, filePath: serverMsg.filePath, direction: 'in'
                    });
                    uiNeedsUpdate = true;
                }
            });

            if (uiNeedsUpdate) reRenderAllMessages();
        } catch (error) { console.error("Error fetching or merging history:", error); }
        finally { refreshBtn.firstElementChild.style.animation = ''; }
    };

    const handleFiles = (files) => {
        if (!files.length) return; [...files].forEach(file => uploadFile(file));
        imagePicker.value = ''; filePicker.value = ''; attachmentPopover.style.display = 'none';
    };

    const handleSendText = () => {
        const text = textInput.value; if (!text.trim()) return;
        const baseName = generateFilenameFromText(text); const timeStr = new Date().toTimeString().slice(0, 8).replace(/:/g, '');
        const filename = `[${timeStr}]${baseName}.txt`; const textFile = new File([text], filename, { type: 'text/plain' });
        uploadFile(textFile, text); textInput.value = ''; textInput.style.height = 'auto'; sendBtn.classList.remove('active');
    };
    
    const uploadFile = (file, originalTextContent = null) => {
        const isText = originalTextContent !== null;
        const message = {
            id: `msg-local-${Date.now()}-${Math.random()}`, content: isText ? originalTextContent : file.name,
            fileName: file.name, size: file.size, isText: isText, status: 'pending', direction: 'out',
            timestamp: Date.now(), filePath: null
        };
        storage.addMessage(message); reRenderAllMessages();
        const msgEl = document.getElementById(message.id);
        const bar = msgEl?.querySelector('.progress-bar');
        const stat = msgEl?.querySelector('.status-text');
        const formData = new FormData(); formData.append('file', file); formData.append('isText', String(isText));
        if (isText) formData.append('textContent', originalTextContent);
        const xhr = new XMLHttpRequest(); xhr.open('POST', '/upload', true);
        xhr.upload.onprogress = (e) => {
            if (e.lengthComputable && bar) {
                const p = Math.round((e.loaded / e.total) * 100); bar.style.width = p + '%';
                if (stat) stat.textContent = `${t('uploading')} ${p}%`;
            }
        };
        xhr.onload = () => {
            if (xhr.status === 200) {
                const res = JSON.parse(xhr.responseText);
                storage.updateMessage(message.id, { status: 'success', filePath: res.filePath, timestamp: Date.now() });
            } else {
                storage.updateMessage(message.id, { status: 'error' });
            }
            reRenderAllMessages();
        };
        xhr.onerror = () => { storage.updateMessage(message.id, { status: 'error' }); reRenderAllMessages(); };
        xhr.send(formData);
    };

    // --- Event Listeners ---
    refreshBtn.addEventListener('click', fetchAndMergeHistory);
    imageBtn.addEventListener('click', () => imagePicker.click());
    fileBtn.addEventListener('click', () => filePicker.click());
    imagePicker.addEventListener('change', (e) => handleFiles(e.target.files));
    filePicker.addEventListener('change', (e) => handleFiles(e.target.files));
    sendBtn.addEventListener('click', handleSendText);
    textInput.addEventListener('input', () => { textInput.style.height = 'auto'; textInput.style.height = textInput.scrollHeight + 'px'; sendBtn.classList.toggle('active', textInput.value.trim().length > 0); });
    attachmentBtn.addEventListener('click', (e) => { e.stopPropagation(); attachmentPopover.style.display = attachmentPopover.style.display === 'block' ? 'none' : 'block'; });
    menuBtn.addEventListener('click', (e) => { e.stopPropagation(); dropdownMenu.style.display = dropdownMenu.style.display === 'block' ? 'none' : 'block'; });
    clearRecordsBtn.addEventListener('click', () => { if (confirm(t('confirmClearRecords'))) { storage.clearAll(); reRenderAllMessages(); } dropdownMenu.style.display = 'none'; });
    document.addEventListener('click', () => { attachmentPopover.style.display = 'none'; dropdownMenu.style.display = 'none'; });
    messageList.addEventListener('click', async (e) => {
        const target = e.target.closest('button.footer-btn'); if (!target) return;
        const id = target.dataset.id, path = target.dataset.path;
        if (target.classList.contains('download-btn')) { window.location.href = `/download?path=${encodeURIComponent(path)}`; }
        else if (target.classList.contains('withdraw-btn')) {
            target.disabled = true; target.textContent = t('withdrawing');
            try {
                const response = await fetch('/delete', { method: 'DELETE', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ filePath: path }) });
                if (response.ok) {
                    const localMessage = storage.getMessages().find(m => m.id === id);
                    if(localMessage) storage.removeMessage(id);
                    document.getElementById(id)?.remove();
                } else { throw new Error(await response.text()); }
            } catch (error) {
                console.error('Withdraw failed:', error);
                if (confirm(t('withdrawFailed') + "\n\n" + t('confirmLocalDelete'))) {
                    storage.removeMessage(id); document.getElementById(id)?.remove();
                } else { target.disabled = false; target.textContent = t('withdraw'); }
            }
        }
    });
    
    // --- Initial Load ---
    const initialLoad = async () => {
        applyStaticTranslations(); reRenderAllMessages(); await fetchAndMergeHistory();
    };
    initialLoad();
    const styleSheet = document.createElement("style");
    styleSheet.innerText = `@keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }`;
    document.head.appendChild(styleSheet);
});
</script>
</body>
</html>